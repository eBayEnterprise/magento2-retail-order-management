#!/bin/bash

main() {
    install_magento && fix_base_url
}

install_magento() {
    cd "${MAGENTO_ROOT_DIR}/bin" && \
       php magento setup:install \
            --base-url="http://localhost/" \
            --backend-frontname="admin" \
            --db-host="db" \
            --db-name="$DB_ENV_MYSQL_DATABASE" \
            --db-user="$DB_ENV_MYSQL_USER" \
            --db-password="$DB_ENV_MYSQL_PASSWORD" \
            --admin-firstname="admin" \
            --admin-lastname="admin" \
            --admin-email="test@example.com" \
            --admin-user="admin" \
            --admin-password="testing123" \
            --language="en_US" \
            --currency="USD" \
            --timezone="America/New_York"
}

fix_base_url() {
    mysql() {
        command mysql -h db -u "$DB_ENV_MYSQL_USER" --password="${DB_ENV_MYSQL_PASSWORD}" "$DB_ENV_MYSQL_DATABASE" "$@"
    }
    mysql -e 'UPDATE core_config_data set value="{{base_url}}" where path="web/unsecure/base_url";'
}

main "$@"
